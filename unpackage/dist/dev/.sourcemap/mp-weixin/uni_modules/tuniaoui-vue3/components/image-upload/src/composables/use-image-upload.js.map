{"version":3,"file":"use-image-upload.js","sources":["uni_modules/tuniaoui-vue3/components/image-upload/src/composables/use-image-upload.ts"],"sourcesContent":["import { computed, getCurrentInstance, nextTick, ref, watch } from 'vue'\nimport { CHANGE_EVENT, UPDATE_MODEL_EVENT } from '../../../../constants'\nimport { debugWarn, isBoolean, isPromise, throwError } from '../../../../utils'\nimport { useFormItem } from '../../../form'\nimport useUploadHandleFunction from './use-upload-handle-function'\n\nimport type { ImageUploadList, ImageUploadListItem } from '../types'\nimport type { ImageUploadProps } from '../image-upload'\n\nexport const useImageUpload = (props: ImageUploadProps) => {\n  const { emit } = getCurrentInstance()!\n  const {\n    chooseImage,\n    uploadProcess,\n    checkFileSizeAndExtension,\n    showErrorTips,\n  } = useUploadHandleFunction(props)\n\n  const { formItem } = useFormItem()\n\n  // 文件列表\n  const fileList = ref<ImageUploadList>([])\n\n  // 监听文件列表变化\n  let isInnerUpdate = false\n  watch(\n    () => props.modelValue,\n    (val) => {\n      if (isInnerUpdate) {\n        isInnerUpdate = false\n        return\n      }\n\n      fileList.value = val.map((item) => ({\n        url: item,\n        status: 'done',\n        progress: 100,\n      }))\n    },\n    {\n      immediate: true,\n    }\n  )\n\n  // 判断是否超过最大上传数\n  const isExceedMaxCount = computed<boolean>(\n    () => fileList.value.length >= props.limit\n  )\n  // 当前剩余可选文件数量\n  const currentRemainFileCount = computed<number>(() => {\n    if (props.multiple) {\n      return props.limit - fileList.value.length\n    } else {\n      return props.limit - fileList.value.length > 0 ? 1 : 0\n    }\n  })\n\n  // 选择文件\n  const chooseFile = async () => {\n    const { disabled, action, customUploadHandler } = props\n    if (disabled) return\n\n    // 如果没有设置action或者没有自定义图片上传处理函数，则直接返回\n    if (!action && !customUploadHandler) {\n      showErrorTips('请设置action或者自定义图片上传处理函数')\n      debugWarn('TnImageUpload', '请设置action或者自定义图片上传处理函数')\n      return\n    }\n    // 选择前已有文件的数量\n    const prevUploadedFileCount = fileList.value.length\n    chooseImage(currentRemainFileCount.value)\n      .then((res) => {\n        let selectFile = res\n        // 判断尺寸和格式是否正确\n        const checkFailFiles = checkFileSizeAndExtension(selectFile)\n        if (checkFailFiles.length) {\n          showErrorTips('文件格式或大小不符合要求')\n          emit('oversizeOrNoSupport', checkFailFiles)\n          // 剔除不符合要求的文件\n          selectFile = selectFile.filter(\n            (item) => !checkFailFiles.includes(item)\n          )\n        }\n        fileList.value.push(\n          ...selectFile.map<ImageUploadListItem>((item) => {\n            const url = (item as UniApp.ChooseImageSuccessCallbackResultFile)\n              .path\n            return {\n              url,\n              status: 'ready',\n              progress: 0,\n              file: item,\n            }\n          })\n        )\n        if (props.autoUpload && selectFile.length)\n          uploadFile(prevUploadedFileCount)\n      })\n      .catch((err) => {\n        debugWarn('TnImageUpload', `选择图片失败: ${err}`)\n        showErrorTips(err?.errMsg || '选择图片失败')\n      })\n  }\n\n  // 处理上传事件\n  const handleUploadEvent = (\n    item: ImageUploadListItem,\n    index: number,\n    uploadSingle = false\n  ) => {\n    uploadProcess(item)\n      .then((res) => {\n        if (res) {\n          handleUploadSuccess(item)\n        } else {\n          handleUploadError(item, '上传失败')\n        }\n      })\n      .catch((err) => {\n        handleUploadError(item, err)\n      })\n      .finally(() => {\n        if (!uploadSingle) uploadFile(index + 1)\n      })\n  }\n\n  // 上传文件\n  const uploadFile = (startIndex: number, uploadSingle = false) => {\n    const { autoUpload, beforeUpload } = props\n    const autoNextUpload = autoUpload && !uploadSingle\n    // 判断是否全部文件上传完毕\n    if (startIndex >= fileList.value.length) {\n      if (props.autoRemoveFaildFile) handleUploadCompleteFailFile()\n      return\n    }\n\n    const fileItem = fileList.value[startIndex]\n\n    // 如果当前上传完毕自动上传下一张\n    if (fileItem.progress === 100) {\n      fileItem.status = 'done'\n      fileItem.uploadTask = undefined\n      if (autoNextUpload) uploadFile(startIndex + 1)\n      return\n    }\n\n    // 上传前回调\n    if (!beforeUpload) {\n      handleUploadEvent(fileItem, startIndex, uploadSingle)\n      return\n    }\n\n    const shouldUpload = beforeUpload(fileItem.file!)\n    const isBeforeUploadPromiseOrBoolean = [\n      isPromise(shouldUpload),\n      isBoolean(shouldUpload),\n    ].includes(true)\n    if (!isBeforeUploadPromiseOrBoolean) {\n      throwError(\n        '[TnImageUpload]',\n        'beforeUpload返回值必须是Promise或者Boolean'\n      )\n    }\n\n    if (isPromise(shouldUpload)) {\n      shouldUpload\n        .then((res) => {\n          if (res) handleUploadEvent(fileItem, startIndex, uploadSingle)\n          else {\n            removeFile(startIndex)\n            if (autoNextUpload) uploadFile(startIndex)\n          }\n        })\n        .catch((err) => {\n          debugWarn('TnImageUpload', `beforeUpload出错: ${err}`)\n          fileItem.status = 'failed'\n        })\n    } else {\n      if (shouldUpload) handleUploadEvent(fileItem, startIndex, uploadSingle)\n      else {\n        removeFile(startIndex)\n        if (autoNextUpload) uploadFile(startIndex)\n      }\n    }\n  }\n\n  // 获取上传成功的文件url\n  const getUploadSuceesFileUrlValue = () => {\n    return fileList.value\n      .filter((item) => item.status === 'done')\n      .map((item) => item.url)\n  }\n\n  // 已上传文件列表发生改变\n  const uploadSuccessFileListChange = () => {\n    isInnerUpdate = true\n    const value = getUploadSuceesFileUrlValue()\n    emit(UPDATE_MODEL_EVENT, value)\n    nextTick(() => {\n      emit(CHANGE_EVENT, value)\n      if (props.validateEvent) {\n        formItem?.validate?.('change').catch((err) => {\n          debugWarn(err)\n        })\n      }\n    })\n  }\n\n  // 处理文件上传成功\n  const handleUploadSuccess = (item: ImageUploadListItem) => {\n    item.status = 'done'\n    item.progress = 100\n    item.uploadTask = undefined\n    item.file = undefined\n    emit('success', item)\n    uploadSuccessFileListChange()\n  }\n\n  // 处理上传文件发生错误\n  const handleUploadError = (item: ImageUploadListItem, errorMsg: string) => {\n    item.status = 'failed'\n    item.progress = 0\n    item.uploadTask = undefined\n    item.file = undefined\n    showErrorTips(errorMsg)\n    emit('fail', new Error(errorMsg), item)\n  }\n\n  // 处理上传完成后失败的文件\n  const handleUploadCompleteFailFile = () => {\n    const tempFileList = [...fileList.value]\n    tempFileList.forEach((item, index) => {\n      if (item.status === 'failed') {\n        removeFile(index)\n      }\n    })\n  }\n\n  // 重新上传文件\n  const retryUploadFile = (index: number) => {\n    const fileItem = fileList.value[index]\n    fileItem.status = 'ready'\n    fileItem.progress = 0\n    uploadFile(index, true)\n  }\n\n  // 重新上传全部文件\n  const retryAllUpload = () => {\n    // 查找出第一张上传失败的图片\n    const firstFailedFileIndex = fileList.value.findIndex(\n      (item) => item.status === 'failed'\n    )\n    uploadFile(firstFailedFileIndex)\n  }\n\n  // 手动上传文件\n  const customUploadHandle = () => {\n    if (!fileList.value.length) return\n    uploadFile(0)\n  }\n\n  // 移除文件\n  const removeFile = (index: number) => {\n    const fileItem = fileList.value[index]\n\n    // 如果文件正在上传中，取消上传\n    if (\n      fileItem.status === 'uploading' &&\n      fileItem.uploadTask &&\n      fileItem.progress > 0 &&\n      fileItem.progress < 100\n    ) {\n      fileItem.uploadTask.abort()\n    }\n\n    fileList.value.splice(index, 1)\n\n    // 如果文件是已经完成的，重新计算上传成功的文件url\n    if (fileItem.status === 'done') {\n      emit('remove', fileItem.url)\n      uploadSuccessFileListChange()\n    }\n  }\n\n  // 删除文件\n  const removeFileEvent = (index: number) => {\n    const { disabled, beforeRemove } = props\n    if (disabled) return\n    // 获取待删除的文件\n    const fileItem = fileList.value[index]\n    if (!fileItem) return\n\n    uni.showModal({\n      title: '操作提示',\n      content: '确认需要移除该图片吗?',\n      showCancel: true,\n      cancelText: '取 消',\n      confirmText: '确 认',\n      success: (res) => {\n        if (res.confirm) {\n          // 删除前回调\n          if (!beforeRemove) {\n            removeFile(index)\n            return\n          }\n\n          const shouldRemove = beforeRemove(fileItem)\n          const isShouldRemovePromiseOrBoolean = [\n            isPromise(shouldRemove),\n            isBoolean(shouldRemove),\n          ].includes(true)\n          if (!isShouldRemovePromiseOrBoolean) {\n            throwError(\n              '[TnImageUpload]',\n              'beforeRemove返回值必须是Promise或者Boolean'\n            )\n          }\n\n          if (isPromise(shouldRemove)) {\n            shouldRemove\n              .then((res) => {\n                if (res) removeFile(index)\n              })\n              .catch((err) => {\n                debugWarn('TnImageUpload', `beforeRemove出错: ${err}`)\n              })\n          } else {\n            if (shouldRemove) removeFile(index)\n          }\n        }\n      },\n    })\n  }\n\n  // 清空文件列表\n  const clearAllFile = () => {\n    // 如果文件正在上传中，取消上传\n    fileList.value.forEach((item) => {\n      if (\n        item.status === 'uploading' &&\n        item.uploadTask &&\n        item.progress > 0 &&\n        item.progress < 100\n      ) {\n        item.uploadTask.abort()\n      }\n    })\n    fileList.value = []\n    uploadSuccessFileListChange()\n  }\n\n  // 点击图片预览图片\n  const previewImage = (index: number) => {\n    const previewImageList = fileList.value\n      .filter((item) => item.status === 'done')\n      .map((item) => item.url)\n\n    uni.previewImage({\n      current: index,\n      urls: previewImageList,\n    })\n\n    emit('preview', previewImageList[index])\n  }\n\n  return {\n    fileList,\n    isExceedMaxCount,\n    chooseFile,\n    retryUploadFile,\n    retryAllUpload,\n    customUploadHandle,\n    removeFileEvent,\n    clearAllFile,\n    previewImage,\n  }\n}\n"],"names":["getCurrentInstance","useUploadHandleFunction","useFormItem","ref","watch","computed","debugWarn","isPromise","isBoolean","throwError","UPDATE_MODEL_EVENT","nextTick","CHANGE_EVENT","uni","res"],"mappings":"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"}