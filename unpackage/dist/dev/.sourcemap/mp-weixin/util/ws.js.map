{"version":3,"file":"ws.js","sources":["util/ws.js"],"sourcesContent":["// utils/ws.js\n\nlet socket = null;\nlet reconnectTimer = null;\nlet isManuallyClosed = false;\n\nconst listeners = new Map();\n\nconst ws = {\n  connect(token) {\n    const url = `wss://wss.hanyunkeji.cn/wss`;\n\t\n\n    if (socket) uni.closeSocket();\n    isManuallyClosed = false;\n\n    socket = uni.connectSocket({ url });\n\t// 在连接 WebSocket 时直接加上 token 参数\n\t// const socket = new WebSocket(`wss://wss.hanyunkeji.cn:2346/?token=${token}`)\n\n\n    // ✅ 全局监听 WebSocket 事件（UniApp 的正确方式）\n    uni.onSocketOpen(() => {\n      console.log('[WS] Connected11111');\n\t  console.log(`kk   ${token}`);\n      ws.send({ type: 'auth', token });\n    });\n\n    uni.onSocketMessage((res) => {\n      let msg;\n      try {\n        msg = JSON.parse(res.data);\n      } catch (e) {\n        console.warn('[WS] 非法消息:', res.data);\n        return;\n      }\n\t  \n\t  console.log(\"收到信息\");\n\n      const event = msg.type;\n      if (listeners.has(event)) {\n        listeners.get(event).forEach(fn => fn(msg));\n      }\n    });\n\n    uni.onSocketClose(() => {\n      console.warn('[WS] Closed');\n      if (!isManuallyClosed) {\n        reconnectTimer = setTimeout(() => ws.connect(token), 3000);\n      }\n    });\n\n    uni.onSocketError((err) => {\n      console.error('[WS] Error:', err);\n    });\n  },\n\n  send(data) {\n    uni.sendSocketMessage({\n      data: JSON.stringify(data),\n      fail: (err) => console.warn('[WS] 发送失败', err)\n    });\n  },\n\n  close() {\n\t  console.log(\"zhix w\");\n    isManuallyClosed = true;\n    uni.closeSocket();\n  },\n\n  on(event, cb) {\n    if (!listeners.has(event)) listeners.set(event, []);\n    listeners.get(event).push(cb);\n  },\n\n  off(event, cb) {\n    if (listeners.has(event)) {\n      const arr = listeners.get(event).filter(fn => fn !== cb);\n      listeners.set(event, arr);\n    }\n  }\n};\n\nexport default ws;\n"],"names":["uni"],"mappings":";;AAEA,IAAI,SAAS;AAEb,IAAI,mBAAmB;AAEvB,MAAM,YAAY,oBAAI;AAEjB,MAAC,KAAK;AAAA,EACT,QAAQ,OAAO;AACb,UAAM,MAAM;AAGZ,QAAI;AAAQA,0BAAI;AAChB,uBAAmB;AAEnB,aAASA,cAAAA,MAAI,cAAc,EAAE,IAAK,CAAA;AAMlCA,kBAAG,MAAC,aAAa,MAAM;AACrBA,oBAAAA,MAAA,MAAA,OAAA,oBAAY,qBAAqB;AACpCA,oBAAA,MAAA,MAAA,OAAA,oBAAY,QAAQ,KAAK,EAAE;AACxB,SAAG,KAAK,EAAE,MAAM,QAAQ,MAAO,CAAA;AAAA,IACrC,CAAK;AAEDA,wBAAI,gBAAgB,CAAC,QAAQ;AAC3B,UAAI;AACJ,UAAI;AACF,cAAM,KAAK,MAAM,IAAI,IAAI;AAAA,MAC1B,SAAQ,GAAG;AACVA,sBAAA,MAAA,MAAA,QAAA,oBAAa,cAAc,IAAI,IAAI;AACnC;AAAA,MACD;AAEJA,oBAAAA,MAAA,MAAA,OAAA,oBAAY,MAAM;AAEf,YAAM,QAAQ,IAAI;AAClB,UAAI,UAAU,IAAI,KAAK,GAAG;AACxB,kBAAU,IAAI,KAAK,EAAE,QAAQ,QAAM,GAAG,GAAG,CAAC;AAAA,MAC3C;AAAA,IACP,CAAK;AAEDA,kBAAG,MAAC,cAAc,MAAM;AACtBA,oBAAAA,MAAa,MAAA,QAAA,oBAAA,aAAa;AAC1B,UAAI,CAAC,kBAAkB;AACJ,mBAAW,MAAM,GAAG,QAAQ,KAAK,GAAG,GAAI;AAAA,MAC1D;AAAA,IACP,CAAK;AAEDA,wBAAI,cAAc,CAAC,QAAQ;AACzBA,6DAAc,eAAe,GAAG;AAAA,IACtC,CAAK;AAAA,EACF;AAAA,EAED,KAAK,MAAM;AACTA,kBAAAA,MAAI,kBAAkB;AAAA,MACpB,MAAM,KAAK,UAAU,IAAI;AAAA,MACzB,MAAM,CAAC,QAAQA,sDAAa,aAAa,GAAG;AAAA,IAClD,CAAK;AAAA,EACF;AAAA,EAED,QAAQ;AACPA,kBAAAA,MAAY,MAAA,OAAA,oBAAA,QAAQ;AACnB,uBAAmB;AACnBA,kBAAG,MAAC,YAAW;AAAA,EAChB;AAAA,EAED,GAAG,OAAO,IAAI;AACZ,QAAI,CAAC,UAAU,IAAI,KAAK;AAAG,gBAAU,IAAI,OAAO,CAAA,CAAE;AAClD,cAAU,IAAI,KAAK,EAAE,KAAK,EAAE;AAAA,EAC7B;AAAA,EAED,IAAI,OAAO,IAAI;AACb,QAAI,UAAU,IAAI,KAAK,GAAG;AACxB,YAAM,MAAM,UAAU,IAAI,KAAK,EAAE,OAAO,QAAM,OAAO,EAAE;AACvD,gBAAU,IAAI,OAAO,GAAG;AAAA,IACzB;AAAA,EACF;AACH;;"}